<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人资料设置 - 家庭物品管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div id="sidebar" class="col-md-3 col-lg-2 sidebar">
                <div class="d-flex justify-content-between align-items-center px-3 mb-4">
                    <h5 class="m-0">家庭物品管理</h5>
                    <button id="sidebar-toggle" class="btn btn-sm btn-outline-light d-md-none" aria-label="切换侧边栏">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}">
                            <i class="bi bi-house"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/items}">
                            <i class="bi bi-box"></i> 物品管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/categories}">
                            <i class="bi bi-tags"></i> 分类管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/spaces}">
                            <i class="bi bi-grid"></i> 空间管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/statistics}">
                            <i class="bi bi-bar-chart"></i> 统计报表
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/settings}">
                            <i class="bi bi-gear"></i> 系统设置
                        </a>
                    </li>
                </ul>
                
                <div class="mt-auto p-3">
                    <div class="d-flex align-items-center mb-3">
                        <img th:if="${user.avatar}" th:src="${user.avatar}" class="rounded-circle me-2" width="32" height="32" alt="用户头像">
                        <img th:unless="${user.avatar}" src="/img/default-avatar.png" class="rounded-circle me-2" width="32" height="32" alt="用户头像">
                        <span th:text="${user.username}">用户名</span>
                    </div>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="btn btn-sm btn-outline-light w-100">
                            <i class="bi bi-box-arrow-right"></i> 退出登录
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div id="content" class="col-md-9 col-lg-10 ms-sm-auto main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">个人资料设置</h1>
                    <a th:href="@{/settings}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> 返回设置
                    </a>
                </div>
                
                <!-- 个人资料卡片 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">基本信息</h5>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="username" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="username" th:value="${user.username}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="email" class="form-label">电子邮箱</label>
                                            <input type="email" class="form-control" id="email" th:value="${user.email}">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="nickname" class="form-label">昵称</label>
                                            <input type="text" class="form-control" id="nickname" th:value="${user.nickname}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="phone" class="form-label">手机号码</label>
                                            <input type="tel" class="form-control" id="phone" th:value="${user.phone}">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save"></i> 保存基本信息
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">修改密码</h5>
                            </div>
                            <div class="card-body">
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">当前密码</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">新密码</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                        <div class="form-text">密码长度必须大于8个字符，包含字母和数字</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirmPassword" class="form-label">确认新密码</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-key"></i> 更新密码
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">通知设置</h5>
                            </div>
                            <div class="card-body">
                                <form id="notificationForm">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailNotification" th:checked="${user.emailNotification}">
                                            <label class="form-check-label" for="emailNotification">接收电子邮件通知</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="warrantyNotification" th:checked="${user.warrantyNotification}">
                                            <label class="form-check-label" for="warrantyNotification">保修到期提醒</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="expiryNotification" th:checked="${user.expiryNotification}">
                                            <label class="form-check-label" for="expiryNotification">物品过期提醒</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reminderDays" class="form-label">提前提醒天数</label>
                                        <input type="number" class="form-control" id="reminderDays" th:value="${user.reminderDays ?: 7}" min="1" max="90">
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-bell"></i> 保存通知设置
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">头像设置</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <img th:if="${user.avatar}" th:src="${user.avatar}" class="rounded-circle mb-3" width="150" height="150" alt="用户头像">
                                    <img th:unless="${user.avatar}" src="/img/default-avatar.png" class="rounded-circle mb-3" width="150" height="150" alt="用户头像">
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary mb-2" id="changeAvatarBtn">
                                        <i class="bi bi-camera"></i> 更换头像
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="removeAvatarBtn">
                                        <i class="bi bi-trash"></i> 移除头像
                                    </button>
                                </div>
                                <input type="file" id="avatarInput" class="d-none" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">账号信息</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>账号状态</span>
                                        <span class="badge bg-success">正常</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>注册时间</span>
                                        <span th:text="${#temporals.format(user.createTime, 'yyyy-MM-dd')}">2023-01-01</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>最后登录</span>
                                        <span>2023-05-10</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 头像裁剪模态框 -->
    <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="avatarModalLabel">裁剪头像</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="avatar-cropper" class="text-center">
                        <img id="avatar-image" src="" alt="头像图片" class="img-fluid">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveAvatarBtn">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <script th:src="@{/js/main.js}"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 头像相关
            let cropper = null;
            const avatarInput = document.getElementById('avatarInput');
            const changeAvatarBtn = document.getElementById('changeAvatarBtn');
            const removeAvatarBtn = document.getElementById('removeAvatarBtn');
            const saveAvatarBtn = document.getElementById('saveAvatarBtn');
            const avatarImage = document.getElementById('avatar-image');
            const avatarModal = new bootstrap.Modal(document.getElementById('avatarModal'));
            
            // 点击更换头像按钮
            changeAvatarBtn.addEventListener('click', function() {
                avatarInput.click();
            });
            
            // 头像文件选择后
            avatarInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        avatarImage.src = e.target.result;
                        avatarModal.show();
                        
                        // 等待模态框显示完毕再初始化裁剪器
                        document.getElementById('avatarModal').addEventListener('shown.bs.modal', function() {
                            if (cropper) {
                                cropper.destroy();
                            }
                            
                            cropper = new Cropper(avatarImage, {
                                aspectRatio: 1,
                                viewMode: 1,
                                minContainerWidth: 300,
                                minContainerHeight: 300
                            });
                        }, { once: true });
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // 保存裁剪后的头像
            saveAvatarBtn.addEventListener('click', function() {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 300,
                        height: 300
                    });
                    
                    canvas.toBlob(function(blob) {
                        const formData = new FormData();
                        formData.append('avatar', blob, 'avatar.png');
                        
                        // 发送到服务器
                        fetch('/api/users/avatar', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                // 更新页面上的头像
                                const avatarImages = document.querySelectorAll('.avatar-image');
                                avatarImages.forEach(img => {
                                    img.src = data.data;
                                });
                                
                                // 关闭模态框
                                avatarModal.hide();
                                
                                // 重置裁剪器
                                cropper.destroy();
                                cropper = null;
                                
                                // 刷新页面
                                window.location.reload();
                            } else {
                                alert('头像上传失败：' + data.msg);
                            }
                        })
                        .catch(error => {
                            console.error('上传出错：', error);
                            alert('上传出错，请重试');
                        });
                    });
                }
            });
            
            // 移除头像
            removeAvatarBtn.addEventListener('click', function() {
                if (confirm('确定要移除头像吗？')) {
                    fetch('/api/users/avatar', {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            window.location.reload();
                        } else {
                            alert('移除头像失败：' + data.msg);
                        }
                    })
                    .catch(error => {
                        console.error('请求出错：', error);
                        alert('请求出错，请重试');
                    });
                }
            });
            
            // 基本信息表单提交
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    email: document.getElementById('email').value,
                    nickname: document.getElementById('nickname').value,
                    phone: document.getElementById('phone').value
                };
                
                fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('基本信息更新成功！');
                    } else {
                        alert('更新失败：' + data.msg);
                    }
                })
                .catch(error => {
                    console.error('请求出错：', error);
                    alert('请求出错，请重试');
                });
            });
            
            // 密码表单提交
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // 验证新密码
                if (newPassword.length < 8) {
                    alert('新密码长度必须大于8个字符');
                    return;
                }
                
                if (!/[a-zA-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
                    alert('新密码必须包含字母和数字');
                    return;
                }
                
                // 验证密码确认
                if (newPassword !== confirmPassword) {
                    alert('两次输入的新密码不一致');
                    return;
                }
                
                const formData = {
                    currentPassword: currentPassword,
                    newPassword: newPassword
                };
                
                fetch('/api/users/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('密码更新成功！');
                        document.getElementById('passwordForm').reset();
                    } else {
                        alert('更新失败：' + data.msg);
                    }
                })
                .catch(error => {
                    console.error('请求出错：', error);
                    alert('请求出错，请重试');
                });
            });
            
            // 通知设置表单提交
            document.getElementById('notificationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    emailNotification: document.getElementById('emailNotification').checked,
                    warrantyNotification: document.getElementById('warrantyNotification').checked,
                    expiryNotification: document.getElementById('expiryNotification').checked,
                    reminderDays: parseInt(document.getElementById('reminderDays').value)
                };
                
                fetch('/api/users/notifications', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('通知设置更新成功！');
                    } else {
                        alert('更新失败：' + data.msg);
                    }
                })
                .catch(error => {
                    console.error('请求出错：', error);
                    alert('请求出错，请重试');
                });
            });
        });
    </script>
</body>
</html> 